name: "ğŸš€ Production CI/CD Pipeline"

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

env:
  NODE_VERSION: '20'
  FORCE_COLOR: 1

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  quality-checks:
    name: "ğŸ” Quality & Security Checks"
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    outputs:
      has-vulnerabilities: ${{ steps.security-scan.outputs.has-vulnerabilities }}
      build-success: ${{ steps.build.outputs.success }}
    
    steps:
    - name: ğŸ“‚ Checkout repository
      uses: actions/checkout@v6

    - name: ğŸ“¦ Setup Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ğŸ”§ Install dependencies
      run: |
        npm ci --prefer-offline --no-audit
        echo "âœ… Dependencies installed successfully"

    - name: ğŸ§¹ Lint & Format Check
      run: |
        echo "ğŸ” Running ESLint..."
        npm run lint 2>&1 | tee lint-results.log || true
        
        echo "ğŸ¨ Checking Prettier formatting..."
        npx prettier --check . || echo "âš ï¸ Formatting issues detected"
        
        # Count lint errors
        LINT_ERRORS=$(grep -c "error" lint-results.log || echo "0")
        echo "ğŸ“Š ESLint errors: $LINT_ERRORS"
        
        if [ "$LINT_ERRORS" -gt 0 ]; then
          echo "âŒ Lint errors found - build will continue but review required"
        else
          echo "âœ… No lint errors detected"
        fi

    - name: ğŸ”’ Security Analysis
      id: security-scan
      run: |
        echo "ğŸ›¡ï¸ Running comprehensive security scan..."
        
        # Dependency vulnerabilities
        echo "ğŸ“¦ Scanning dependencies..."
        npm audit --audit-level=moderate --json > audit-results.json 2>/dev/null || true
        
        CRITICAL=$(jq '.metadata.vulnerabilities.critical // 0' audit-results.json)
        HIGH=$(jq '.metadata.vulnerabilities.high // 0' audit-results.json)
        MODERATE=$(jq '.metadata.vulnerabilities.moderate // 0' audit-results.json)
        
        echo "critical-vulns=$CRITICAL" >> $GITHUB_OUTPUT
        echo "high-vulns=$HIGH" >> $GITHUB_OUTPUT
        echo "moderate-vulns=$MODERATE" >> $GITHUB_OUTPUT
        
        # Check for critical/high vulnerabilities
        if [ "$CRITICAL" -gt 0 ] || [ "$HIGH" -gt 0 ]; then
          echo "has-vulnerabilities=true" >> $GITHUB_OUTPUT
          echo "ğŸš¨ Critical/High vulnerabilities detected!"
        else
          echo "has-vulnerabilities=false" >> $GITHUB_OUTPUT
          echo "âœ… No critical vulnerabilities found"
        fi
        
        # Secret scanning (basic patterns)
        echo "ğŸ” Scanning for exposed secrets..."
        SECRET_PATTERNS=0
        
        # Common secret patterns
        if find . -name "*.js" -o -name "*.ts" -o -name "*.jsx" -o -name "*.tsx" | \
           xargs grep -l -i -E "(api[_-]?key|secret|token|password|private[_-]?key)" 2>/dev/null; then
          SECRET_PATTERNS=1
          echo "âš ï¸ Potential secrets detected in code"
        fi
        
        echo "secret-patterns=$SECRET_PATTERNS" >> $GITHUB_OUTPUT
        
        # Summary
        echo "## ğŸ›¡ï¸ Security Scan Results" >> $GITHUB_STEP_SUMMARY
        echo "- **Critical Vulnerabilities:** $CRITICAL" >> $GITHUB_STEP_SUMMARY
        echo "- **High Vulnerabilities:** $HIGH" >> $GITHUB_STEP_SUMMARY
        echo "- **Moderate Vulnerabilities:** $MODERATE" >> $GITHUB_STEP_SUMMARY
        echo "- **Potential Secret Patterns:** $SECRET_PATTERNS" >> $GITHUB_STEP_SUMMARY

    - name: ğŸ“ TypeScript Check
      run: |
        echo "ğŸ” TypeScript compilation check..."
        npx tsc --noEmit --skipLibCheck 2>&1 | tee ts-check.log || true
        
        TS_ERRORS=$(grep -c "error TS" ts-check.log || echo "0")
        echo "ğŸ“Š TypeScript errors: $TS_ERRORS"
        
        if [ "$TS_ERRORS" -gt 0 ]; then
          echo "âŒ TypeScript errors detected"
          cat ts-check.log
        else
          echo "âœ… TypeScript compilation successful"
        fi

    - name: ğŸ§ª Run Tests
      run: |
        echo "ğŸ§ª Running test suite..."
        if npm run test --if-present 2>/dev/null; then
          echo "âœ… All tests passed"
        else
          echo "â„¹ï¸ No tests configured or tests failed"
        fi

    - name: ğŸ—ï¸ Build Application
      id: build
      run: |
        echo "ğŸ—ï¸ Building production application..."
        
        if npm run build; then
          echo "success=true" >> $GITHUB_OUTPUT
          echo "âœ… Build completed successfully"
          
          # Check build output size
          if [ -d ".next" ]; then
            BUILD_SIZE=$(du -sh .next 2>/dev/null | cut -f1 || echo "unknown")
            echo "ğŸ“¦ Build size: $BUILD_SIZE"
          fi
        else
          echo "success=false" >> $GITHUB_OUTPUT
          echo "âŒ Build failed"
          exit 1
        fi

    - name: ğŸ“Š Bundle Analysis
      run: |
        echo "ğŸ“Š Analyzing bundle size..."
        if [ -f "package.json" ] && grep -q "analyze" package.json; then
          npm run analyze --if-present || echo "Bundle analysis not available"
        else
          echo "â„¹ï¸ Bundle analysis not configured"
        fi

    - name: ğŸ” Performance Audit
      run: |
        echo "âš¡ Performance check..."
        if [ -d ".next" ]; then
          echo "âœ… Next.js build optimized"
          
          # Check for large files
          find .next -name "*.js" -size +1M 2>/dev/null | while read file; do
            size=$(du -h "$file" | cut -f1)
            echo "âš ï¸ Large bundle detected: $file ($size)"
          done || echo "âœ… No oversized bundles detected"
        fi

    - name: ğŸ“‹ Upload Artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: quality-reports
        path: |
          audit-results.json
          lint-results.log
          ts-check.log
        retention-days: 30

  production-readiness:
    name: "ğŸš€ Production Readiness"
    runs-on: ubuntu-latest
    needs: quality-checks
    if: always()
    
    steps:
    - name: ğŸ“Š Generate Production Report
      run: |
        echo "## ğŸš€ Production Readiness Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âœ… Quality Checks:" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ needs.quality-checks.outputs.build-success }}" = "true" ]; then
          echo "- âœ… **Build:** Successful" >> $GITHUB_STEP_SUMMARY
        else
          echo "- âŒ **Build:** Failed" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ needs.quality-checks.outputs.has-vulnerabilities }}" = "false" ]; then
          echo "- âœ… **Security:** No critical vulnerabilities" >> $GITHUB_STEP_SUMMARY
        else
          echo "- âš ï¸ **Security:** Vulnerabilities detected" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ¯ Production Status:" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ needs.quality-checks.outputs.build-success }}" = "true" ] && \
           [ "${{ needs.quality-checks.outputs.has-vulnerabilities }}" = "false" ]; then
          echo "ğŸŸ¢ **READY FOR PRODUCTION**" >> $GITHUB_STEP_SUMMARY
        else
          echo "ğŸŸ¡ **REVIEW REQUIRED BEFORE PRODUCTION**" >> $GITHUB_STEP_SUMMARY
        fi

    - name: ğŸ’¬ Comment PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const buildSuccess = '${{ needs.quality-checks.outputs.build-success }}' === 'true';
          const hasVulns = '${{ needs.quality-checks.outputs.has-vulnerabilities }}' === 'true';
          
          let status = 'ğŸŸ¢';
          let message = 'Ready for production deployment';
          
          if (!buildSuccess) {
            status = 'ğŸ”´';
            message = 'Build failed - deployment blocked';
          } else if (hasVulns) {
            status = 'ğŸŸ¡';
            message = 'Security vulnerabilities detected - review required';
          }
          
          const body = `## ğŸš€ Production Pipeline Results
          
          ${status} **${message}**
          
          ### ğŸ“Š Summary:
          - **Build Status:** ${buildSuccess ? 'âœ… Success' : 'âŒ Failed'}
          - **Security Status:** ${hasVulns ? 'âš ï¸ Issues detected' : 'âœ… Clean'}
          - **Ready for Production:** ${buildSuccess && !hasVulns ? 'âœ… Yes' : 'âŒ No'}
          
          ### ğŸ”— Details:
          [View full pipeline results](${context.payload.repository.html_url}/actions/runs/${context.runId})
          
          ---
          *ğŸ¤– Automated production readiness check*`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: body
          });