name: "Dependency Security Scan"

on:
  push:
    branches: [ "main" ]
    paths:
      - 'package.json'
      - 'package-lock.json'
  pull_request:
    branches: [ "main" ]
    paths:
      - 'package.json'
      - 'package-lock.json'
  schedule:
    # Scan quotidien des vulnÃ©rabilitÃ©s
    - cron: '0 4 * * *'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  pull-requests: write

jobs:
  dependency-scan:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run npm audit
      id: npm-audit
      run: |
        # Audit avec sortie JSON pour parsing
        npm audit --audit-level=moderate --json > audit-results.json || true
        
        # Compter les vulnÃ©rabilitÃ©s
        CRITICAL=$(cat audit-results.json | jq '.metadata.vulnerabilities.critical // 0')
        HIGH=$(cat audit-results.json | jq '.metadata.vulnerabilities.high // 0')
        MODERATE=$(cat audit-results.json | jq '.metadata.vulnerabilities.moderate // 0')
        
        echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
        echo "high=$HIGH" >> $GITHUB_OUTPUT
        echo "moderate=$MODERATE" >> $GITHUB_OUTPUT
        
        # Afficher rÃ©sumÃ©
        echo "ðŸ” Vulnerability Summary:"
        echo "Critical: $CRITICAL"
        echo "High: $HIGH" 
        echo "Moderate: $MODERATE"

    - name: Upload audit results
      uses: actions/upload-artifact@v4
      with:
        name: npm-audit-results
        path: audit-results.json

    - name: Check for critical vulnerabilities
      if: steps.npm-audit.outputs.critical > 0
      run: |
        echo "âŒ Critical vulnerabilities found!"
        npm audit --audit-level=critical
        exit 1

    - name: Comment PR with security results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const critical = '${{ steps.npm-audit.outputs.critical }}';
          const high = '${{ steps.npm-audit.outputs.high }}';
          const moderate = '${{ steps.npm-audit.outputs.moderate }}';
          
          let status = 'âœ…';
          let message = 'No critical security vulnerabilities detected';
          
          if (critical > 0) {
            status = 'ðŸš¨';
            message = `${critical} critical vulnerabilities found!`;
          } else if (high > 0) {
            status = 'âš ï¸';
            message = `${high} high-severity vulnerabilities found`;
          } else if (moderate > 0) {
            status = 'ðŸ“';
            message = `${moderate} moderate vulnerabilities found`;
          }
          
          const body = `## ðŸ”’ Dependency Security Scan
          
          ${status} **${message}**
          
          ### Summary:
          - **Critical:** ${critical}
          - **High:** ${high}  
          - **Moderate:** ${moderate}
          
          ${critical > 0 ? '**Action Required:** Please fix critical vulnerabilities before merging.' : ''}
          
          [View full audit results in the workflow run](${context.payload.repository.html_url}/actions/runs/${context.runId})`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: body
          });

  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: dependency-scan
    if: always()
    
    steps:
    - name: Download audit results
      uses: actions/download-artifact@v4
      with:
        name: npm-audit-results

    - name: Generate security summary
      run: |
        echo "## ðŸ”’ Daily Security Report" >> security-summary.md
        echo "" >> security-summary.md
        echo "**Date:** $(date -u)" >> security-summary.md
        echo "" >> security-summary.md
        
        if [ -f audit-results.json ]; then
          TOTAL=$(cat audit-results.json | jq '.metadata.totalDependencies // 0')
          CRITICAL=$(cat audit-results.json | jq '.metadata.vulnerabilities.critical // 0')
          HIGH=$(cat audit-results.json | jq '.metadata.vulnerabilities.high // 0')
          MODERATE=$(cat audit-results.json | jq '.metadata.vulnerabilities.moderate // 0')
          
          echo "### Dependencies Status:" >> security-summary.md
          echo "- **Total Dependencies:** $TOTAL" >> security-summary.md
          echo "- **Critical Vulnerabilities:** $CRITICAL" >> security-summary.md
          echo "- **High Vulnerabilities:** $HIGH" >> security-summary.md
          echo "- **Moderate Vulnerabilities:** $MODERATE" >> security-summary.md
          echo "" >> security-summary.md
          
          if [ "$CRITICAL" -gt 0 ] || [ "$HIGH" -gt 0 ]; then
            echo "âš ï¸ **Action Required:** Security vulnerabilities detected" >> security-summary.md
          else
            echo "âœ… **All Clear:** No critical security issues found" >> security-summary.md
          fi
        else
          echo "âŒ **Error:** Unable to generate security report" >> security-summary.md
        fi

    - name: Upload security summary
      uses: actions/upload-artifact@v4
      with:
        name: security-summary
        path: security-summary.md