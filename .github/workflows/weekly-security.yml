name: "ðŸ›¡ï¸ Weekly Security Report"

on:
  schedule:
    # Every Monday at 9 AM
    - cron: '0 9 * * 1'
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  security-report:
    name: "Weekly Security Audit"
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“‚ Checkout repository
      uses: actions/checkout@v6

    - name: ðŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: ðŸ”§ Install dependencies
      run: npm ci --prefer-offline

    - name: ðŸ›¡ï¸ Comprehensive Security Audit
      id: audit
      run: |
        echo "ðŸ” Running weekly security audit..."
        
        # Dependencies audit
        npm audit --audit-level=low --json > weekly-audit.json 2>/dev/null || true
        
        CRITICAL=$(jq '.metadata.vulnerabilities.critical // 0' weekly-audit.json)
        HIGH=$(jq '.metadata.vulnerabilities.high // 0' weekly-audit.json)
        MODERATE=$(jq '.metadata.vulnerabilities.moderate // 0' weekly-audit.json)
        LOW=$(jq '.metadata.vulnerabilities.low // 0' weekly-audit.json)
        TOTAL_DEPS=$(jq '.metadata.totalDependencies // 0' weekly-audit.json)
        
        # Outdated packages
        OUTDATED=$(npm outdated --json 2>/dev/null | jq 'length' || echo "0")
        
        echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
        echo "high=$HIGH" >> $GITHUB_OUTPUT
        echo "moderate=$MODERATE" >> $GITHUB_OUTPUT
        echo "low=$LOW" >> $GITHUB_OUTPUT
        echo "total-deps=$TOTAL_DEPS" >> $GITHUB_OUTPUT
        echo "outdated=$OUTDATED" >> $GITHUB_OUTPUT
        
        # Determine if action needed
        if [ "$CRITICAL" -gt 0 ] || [ "$HIGH" -gt 0 ]; then
          echo "needs-attention=true" >> $GITHUB_OUTPUT
        else
          echo "needs-attention=false" >> $GITHUB_OUTPUT
        fi

    - name: ðŸ“Š Generate Report
      id: report
      run: |
        REPORT_DATE=$(date '+%Y-%m-%d')
        
        cat > security-report.md << 'EOF'
        # ðŸ›¡ï¸ Weekly Security Report
        
        **Report Date:** $REPORT_DATE
        **Repository:** ${{ github.repository }}
        
        ## ðŸ“Š Overview
        
        - **Total Dependencies:** ${{ steps.audit.outputs.total-deps }}
        - **Outdated Packages:** ${{ steps.audit.outputs.outdated }}
        
        ## ðŸš¨ Vulnerability Summary
        
        | Severity | Count | Status |
        |----------|-------|--------|
        | ðŸ”´ Critical | ${{ steps.audit.outputs.critical }} | ${{ steps.audit.outputs.critical == '0' && 'âœ…' || 'ðŸš¨' }} |
        | ðŸŸ  High | ${{ steps.audit.outputs.high }} | ${{ steps.audit.outputs.high == '0' && 'âœ…' || 'âš ï¸' }} |
        | ðŸŸ¡ Moderate | ${{ steps.audit.outputs.moderate }} | ${{ steps.audit.outputs.moderate == '0' && 'âœ…' || 'ðŸ“' }} |
        | ðŸ”µ Low | ${{ steps.audit.outputs.low }} | ${{ steps.audit.outputs.low == '0' && 'âœ…' || 'â„¹ï¸' }} |
        
        ## ðŸŽ¯ Action Items
        EOF
        
        if [ "${{ steps.audit.outputs.needs-attention }}" = "true" ]; then
          cat >> security-report.md << 'EOF'
        
        âš ï¸ **Immediate Action Required**
        
        Critical or high-severity vulnerabilities detected:
        
        ### ðŸ”§ Recommended Steps:
        1. Run `npm audit` to see detailed vulnerability information
        2. Update affected packages: `npm audit fix`
        3. For unfixable issues, consider alternative packages
        4. Test thoroughly after updates
        5. Deploy security fixes to production
        
        ### ðŸ“‹ Manual Review Required:
        - Review each vulnerability impact on the application
        - Check if patches are available
        - Consider temporary mitigations if patches unavailable
        EOF
        else
          cat >> security-report.md << 'EOF'
        
        âœ… **All Clear**
        
        No critical or high-severity vulnerabilities detected.
        
        ### ðŸ”„ Maintenance Recommendations:
        - Keep dependencies updated through Dependabot
        - Monitor security advisories for used packages
        - Run periodic manual audits
        - Consider upgrading outdated dependencies
        EOF
        fi
        
        echo "report-generated=true" >> $GITHUB_OUTPUT

    - name: ðŸš¨ Create Security Issue
      if: steps.audit.outputs.needs-attention == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const report = fs.readFileSync('security-report.md', 'utf8');
          
          const critical = ${{ steps.audit.outputs.critical }};
          const high = ${{ steps.audit.outputs.high }};
          
          // Check for existing open security issues
          const existingIssues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open',
            labels: 'security,urgent'
          });
          
          const hasOpenSecurityIssue = existingIssues.data.length > 0;
          
          if (!hasOpenSecurityIssue) {
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸš¨ Security Vulnerabilities Detected (${critical} critical, ${high} high)`,
              body: report,
              labels: ['security', 'urgent', 'production-impact'],
              assignees: ['Temmiiee']
            });
            
            console.log(`ðŸš¨ Security issue created: #${issue.data.number}`);
          } else {
            console.log('ðŸ“ Open security issue already exists, updating with comment');
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: existingIssues.data[0].number,
              body: `## ðŸ”„ Updated Security Report\n\n${report}`
            });
          }

    - name: ðŸ“ˆ Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: weekly-security-report
        path: |
          security-report.md
          weekly-audit.json
        retention-days: 90

    - name: ðŸ“‹ Summary
      run: |
        echo "## ðŸ›¡ï¸ Weekly Security Audit Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Dependencies:** ${{ steps.audit.outputs.total-deps }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Critical Vulnerabilities:** ${{ steps.audit.outputs.critical }}" >> $GITHUB_STEP_SUMMARY
        echo "- **High Vulnerabilities:** ${{ steps.audit.outputs.high }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Action Required:** ${{ steps.audit.outputs.needs-attention == 'true' && 'Yes âš ï¸' || 'No âœ…' }}" >> $GITHUB_STEP_SUMMARY