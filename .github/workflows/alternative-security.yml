name: "Alternative Security Analysis"

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  schedule:
    # Analyse quotidienne Ã  4h
    - cron: '0 4 * * *'
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  security-analysis:
    name: Security Analysis (Public Repo)
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run npm audit (Security check)
      id: npm-audit
      run: |
        echo "ðŸ” Scanning dependencies for vulnerabilities..."
        npm audit --audit-level=moderate --json > audit-results.json || true
        
        # Parse results
        CRITICAL=$(cat audit-results.json | jq '.metadata.vulnerabilities.critical // 0')
        HIGH=$(cat audit-results.json | jq '.metadata.vulnerabilities.high // 0')
        MODERATE=$(cat audit-results.json | jq '.metadata.vulnerabilities.moderate // 0')
        
        echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
        echo "high=$HIGH" >> $GITHUB_OUTPUT
        echo "moderate=$MODERATE" >> $GITHUB_OUTPUT
        
        echo "## ðŸ›¡ï¸ Security Scan Results" >> $GITHUB_STEP_SUMMARY
        echo "- **Critical vulnerabilities:** $CRITICAL" >> $GITHUB_STEP_SUMMARY
        echo "- **High vulnerabilities:** $HIGH" >> $GITHUB_STEP_SUMMARY
        echo "- **Moderate vulnerabilities:** $MODERATE" >> $GITHUB_STEP_SUMMARY

    - name: ESLint Security Analysis
      run: |
        echo "ðŸ” Running ESLint security analysis..."
        npx eslint . --ext .js,.jsx,.ts,.tsx --format json > eslint-results.json || true
        
        # Count security issues
        SECURITY_ISSUES=$(cat eslint-results.json | jq '[.[] | select(.messages[] | .ruleId | test("security"))] | length')
        echo "ðŸ”’ Security-related ESLint issues: $SECURITY_ISSUES"
        
        echo "- **ESLint security issues:** $SECURITY_ISSUES" >> $GITHUB_STEP_SUMMARY

    - name: TypeScript security check
      run: |
        echo "ðŸ” TypeScript strict mode verification..."
        npx tsc --noEmit --strict 2>&1 | tee ts-check.log || true
        
        TS_ERRORS=$(cat ts-check.log | grep -c "error TS" || echo "0")
        echo "ðŸ“ TypeScript strict errors: $TS_ERRORS"
        
        echo "- **TypeScript strict errors:** $TS_ERRORS" >> $GITHUB_STEP_SUMMARY

    - name: Check for secrets in code
      run: |
        echo "ðŸ” Scanning for potential secrets..."
        
        # Simple regex patterns for common secrets
        POTENTIAL_SECRETS=0
        
        # API keys, tokens, passwords
        if grep -r -i -E "(api[_-]?key|secret|token|password|pwd)" --include="*.js" --include="*.ts" --include="*.jsx" --include="*.tsx" src/ 2>/dev/null; then
          POTENTIAL_SECRETS=$((POTENTIAL_SECRETS + 1))
        fi
        
        # Database URLs, connection strings
        if grep -r -E "(mongodb://|postgres://|mysql://|redis://)" --include="*.js" --include="*.ts" src/ 2>/dev/null; then
          POTENTIAL_SECRETS=$((POTENTIAL_SECRETS + 1))
        fi
        
        echo "ðŸ” Potential secrets found: $POTENTIAL_SECRETS"
        echo "- **Potential secrets in code:** $POTENTIAL_SECRETS" >> $GITHUB_STEP_SUMMARY

    - name: Build verification
      run: |
        echo "ðŸ—ï¸ Verifying build security..."
        npm run build
        
        echo "âœ… Build completed successfully" >> $GITHUB_STEP_SUMMARY

    - name: Comment PR with results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const critical = '${{ steps.npm-audit.outputs.critical }}';
          const high = '${{ steps.npm-audit.outputs.high }}';
          const moderate = '${{ steps.npm-audit.outputs.moderate }}';
          
          let status = 'âœ…';
          let message = 'Security analysis completed successfully';
          
          if (critical > 0) {
            status = 'ðŸš¨';
            message = `Critical security issues detected!`;
          } else if (high > 0) {
            status = 'âš ï¸';
            message = `High-severity security issues found`;
          }
          
          const body = `## ðŸ›¡ï¸ Security Analysis Results
          
          ${status} **${message}**
          
          ### Vulnerability Summary:
          - ðŸ”´ **Critical:** ${critical}
          - ðŸŸ  **High:** ${high}
          - ðŸŸ¡ **Moderate:** ${moderate}
          
          ### Actions:
          ${critical > 0 || high > 0 ? 'âš ï¸ **Please review and fix security vulnerabilities before merging**' : 'âœ… No critical security issues detected'}
          
          *Note: This analysis runs without GitHub Advanced Security features (CodeQL) as they require an Organization account.*`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: body
          });

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: security-analysis-results
        path: |
          audit-results.json
          eslint-results.json
          ts-check.log

    - name: Final security assessment
      run: |
        echo "## ðŸŽ¯ Security Analysis Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Alternative security analysis completed for public repository.**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### â„¹ï¸ Note about GitHub Advanced Security:" >> $GITHUB_STEP_SUMMARY
        echo "CodeQL and other Advanced Security features require:" >> $GITHUB_STEP_SUMMARY
        echo "- GitHub Organization account (not personal)" >> $GITHUB_STEP_SUMMARY
        echo "- GitHub Advanced Security license" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ›¡ï¸ Current security measures:" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Dependency vulnerability scanning (npm audit)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… ESLint security rules" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… TypeScript strict mode" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Secret scanning (basic patterns)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Dependabot security updates" >> $GITHUB_STEP_SUMMARY