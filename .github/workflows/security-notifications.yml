name: "Security Notifications"

on:
  schedule:
    # VÃ©rification hebdomadaire le lundi Ã  9h
    - cron: '0 9 * * 1'
  workflow_dispatch:

permissions:
  contents: read
  issues: write
  security-events: read

jobs:
  security-check:
    name: Weekly Security Review
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run comprehensive security audit
      id: security-audit
      run: |
        # Audit complet
        npm audit --json > audit-full.json || true
        
        # Statistiques
        TOTAL_DEPS=$(npm list --depth=0 --json | jq '.dependencies | length')
        OUTDATED=$(npm outdated --json 2>/dev/null | jq 'length' || echo 0)
        
        # VulnÃ©rabilitÃ©s par niveau
        CRITICAL=$(cat audit-full.json | jq '.metadata.vulnerabilities.critical // 0')
        HIGH=$(cat audit-full.json | jq '.metadata.vulnerabilities.high // 0')
        MODERATE=$(cat audit-full.json | jq '.metadata.vulnerabilities.moderate // 0')
        LOW=$(cat audit-full.json | jq '.metadata.vulnerabilities.low // 0')
        
        echo "total_deps=$TOTAL_DEPS" >> $GITHUB_OUTPUT
        echo "outdated=$OUTDATED" >> $GITHUB_OUTPUT
        echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
        echo "high=$HIGH" >> $GITHUB_OUTPUT
        echo "moderate=$MODERATE" >> $GITHUB_OUTPUT
        echo "low=$LOW" >> $GITHUB_OUTPUT
        
        # VÃ©rifier si action requise
        if [ "$CRITICAL" -gt 0 ] || [ "$HIGH" -gt 0 ]; then
          echo "needs_attention=true" >> $GITHUB_OUTPUT
        else
          echo "needs_attention=false" >> $GITHUB_OUTPUT
        fi

    - name: Generate security report
      id: report
      run: |
        REPORT_DATE=$(date '+%Y-%m-%d')
        
        cat > security-report.md << EOF
        # ðŸ”’ Rapport de SÃ©curitÃ© Hebdomadaire
        
        **Date du rapport:** $REPORT_DATE
        
        ## ðŸ“Š Vue d'ensemble
        
        - **Total des dÃ©pendances:** ${{ steps.security-audit.outputs.total_deps }}
        - **DÃ©pendances obsolÃ¨tes:** ${{ steps.security-audit.outputs.outdated }}
        
        ## ðŸš¨ VulnÃ©rabilitÃ©s dÃ©tectÃ©es
        
        | Niveau | Nombre |
        |--------|--------|
        | ðŸ”´ **Critique** | ${{ steps.security-audit.outputs.critical }} |
        | ðŸŸ  **Ã‰levÃ©** | ${{ steps.security-audit.outputs.high }} |
        | ðŸŸ¡ **ModÃ©rÃ©** | ${{ steps.security-audit.outputs.moderate }} |
        | ðŸ”µ **Faible** | ${{ steps.security-audit.outputs.low }} |
        
        ## ðŸŽ¯ Actions recommandÃ©es
        EOF
        
        if [ "${{ steps.security-audit.outputs.needs_attention }}" = "true" ]; then
          cat >> security-report.md << EOF
        
        âš ï¸ **Attention requise:** Des vulnÃ©rabilitÃ©s critiques ou Ã©levÃ©es ont Ã©tÃ© dÃ©tectÃ©es.
        
        ### Ã‰tapes suivantes:
        1. Examiner les vulnÃ©rabilitÃ©s dans l'onglet Security
        2. Mettre Ã  jour les dÃ©pendances concernÃ©es
        3. Tester l'application aprÃ¨s les mises Ã  jour
        4. DÃ©ployer les corrections en production
        
        ### Commandes utiles:
        \`\`\`bash
        # Voir les vulnÃ©rabilitÃ©s dÃ©taillÃ©es
        npm audit
        
        # Corriger automatiquement (si possible)
        npm audit fix
        
        # Forcer les corrections (attention aux breaking changes)
        npm audit fix --force
        \`\`\`
        EOF
        else
          cat >> security-report.md << EOF
        
        âœ… **Excellent!** Aucune vulnÃ©rabilitÃ© critique ou Ã©levÃ©e dÃ©tectÃ©e.
        
        ### Maintenance recommandÃ©e:
        - Continuer Ã  surveiller les nouvelles vulnÃ©rabilitÃ©s
        - Mettre Ã  jour rÃ©guliÃ¨rement les dÃ©pendances
        - Effectuer des audits de sÃ©curitÃ© pÃ©riodiques
        EOF
        fi
        
        echo "report_created=true" >> $GITHUB_OUTPUT

    - name: Create security issue (if needed)
      if: steps.security-audit.outputs.needs_attention == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const report = fs.readFileSync('security-report.md', 'utf8');
          
          const critical = ${{ steps.security-audit.outputs.critical }};
          const high = ${{ steps.security-audit.outputs.high }};
          
          const title = `ðŸš¨ VulnÃ©rabilitÃ©s de sÃ©curitÃ© dÃ©tectÃ©es (${critical} critiques, ${high} Ã©levÃ©es)`;
          
          // VÃ©rifier si une issue similaire existe dÃ©jÃ 
          const existingIssues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open',
            labels: 'security'
          });
          
          const hasOpenSecurityIssue = existingIssues.data.some(issue => 
            issue.title.includes('VulnÃ©rabilitÃ©s de sÃ©curitÃ©')
          );
          
          if (!hasOpenSecurityIssue) {
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: report,
              labels: ['security', 'high-priority', 'dependencies']
            });
            
            console.log(`Issue de sÃ©curitÃ© crÃ©Ã©e: #${issue.data.number}`);
          } else {
            console.log('Une issue de sÃ©curitÃ© ouverte existe dÃ©jÃ ');
          }

    - name: Upload security artifacts
      uses: actions/upload-artifact@v4
      with:
        name: security-report
        path: |
          security-report.md
          audit-full.json

    - name: Summary
      run: |
        echo "## ðŸ”’ RÃ©sumÃ© du scan de sÃ©curitÃ©" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **DÃ©pendances totales:** ${{ steps.security-audit.outputs.total_deps }}" >> $GITHUB_STEP_SUMMARY
        echo "- **VulnÃ©rabilitÃ©s critiques:** ${{ steps.security-audit.outputs.critical }}" >> $GITHUB_STEP_SUMMARY
        echo "- **VulnÃ©rabilitÃ©s Ã©levÃ©es:** ${{ steps.security-audit.outputs.high }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.security-audit.outputs.needs_attention }}" = "true" ]; then
          echo "âš ï¸ **Action requise:** VulnÃ©rabilitÃ©s critiques dÃ©tectÃ©es" >> $GITHUB_STEP_SUMMARY
        else
          echo "âœ… **Statut:** Aucune vulnÃ©rabilitÃ© critique" >> $GITHUB_STEP_SUMMARY
        fi